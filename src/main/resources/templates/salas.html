<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

    <head th:replace="~{layout/layout :: head('Buscar Salas')}">
    </head>

    <body class="d-flex flex-column min-vh-100">

        <header th:replace="~{layout/layout :: header}"></header>

        <main class="container flex-grow-1 my-4">
            <div class="row">
                <div class="col-lg-3">
                    <div class="card shadow-sm border-0 sticky-top" style="top: 20px;">
                        <div class="card-header bg-light">
                            <h5 class="mb-0"><i class="bi bi-funnel-fill me-2"></i>Filtros de Búsqueda</h5>
                        </div>
                        <div class="card-body">
                            <form id="filterForm">
                                <div class="mb-3">
                                    <label for="capacidadMinima" class="form-label">Capacidad Mínima</label>
                                    <input type="number" class="form-control" id="capacidadMinima" min="1" placeholder="Ej: 5">
                                </div>
                                <div class="mb-3">
                                    <label for="tipoEquipo" class="form-label">Tipo de Equipo</label>
                                    <input type="text" class="form-control" id="tipoEquipo" placeholder="Ej: Proyector">
                                    <div class="form-text">Filtra por tipo de equipo (Proyector, Pizarra, etc.)</div>
                                </div>
                                <div class="mb-3">
                                    <label for="estado" class="form-label">Estado de la Sala</label>
                                    <select class="form-select" id="estado">
                                        <option value="" selected>Todas</option>
                                        <option value="true">Solo Activas</option>
                                        <option value="false">Solo Inactivas</option>
                                    </select>
                                </div>
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary"><i class="bi bi-search me-1"></i> Buscar</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-lg-9">
                    <h1 class="mb-4">Catálogo de Salas</h1> 

                    <div id="error-message" class="alert alert-danger d-none" role="alert">
                        Ocurrió un error al cargar las salas.
                    </div>

                    <div id="loading-spinner" class="text-center my-5 d-none">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-2">Cargando salas...</p>
                    </div>

                    <div id="salas-container" class="row g-4">
                    </div>

                    <div id="no-results" class="text-center my-5 d-none">
                        <i class="bi bi-emoji-frown fs-1 text-muted"></i>
                        <h4 class="mt-3">No se encontraron salas</h4>
                        <p class="text-muted">Intenta ajustar los filtros de búsqueda.</p>
                    </div>

                    <nav id="pagination-controls" aria-label="Navegación de páginas" class="mt-5 d-none">
                        <ul class="pagination justify-content-center">
                            <li class="page-item" id="prev-page">
                                <a class="page-link" href="#" aria-label="Anterior">
                                    <span aria-hidden="true">&laquo; Anterior</span>
                                </a>
                            </li>
                            <li class="page-item disabled">
                                <span class="page-link" id="page-info">Página 1 de 1</span>
                            </li>
                            <li class="page-item" id="next-page">
                                <a class="page-link" href="#" aria-label="Siguiente">
                                    <span aria-hidden="true">Siguiente &raquo;</span>
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </main>

        <footer th:replace="~{layout/layout :: footer}"></footer>

    <th:block th:replace="~{layout/layout :: scripts}"></th:block>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
        const token = localStorage.getItem("jwtToken");
                const filterForm = document.getElementById("filterForm");
                const salasContainer = document.getElementById("salas-container");
                const paginationControls = document.getElementById("pagination-controls");
                const pageInfo = document.getElementById("page-info");
                const prevPage = document.getElementById("prev-page");
                const nextPage = document.getElementById("next-page");
                const errorMessage = document.getElementById("error-message");
                const loadingSpinner = document.getElementById("loading-spinner");
                const noResults = document.getElementById("no-results");
                let currentPage = 0;
                let totalPages = 0;
                const pageSize = 10;
                if (!token) {
        window.location.href = "/login?redirect=salas";
                return;
        }

        async function fetchSalas(page = 0) {
        loadingSpinner.classList.remove("d-none");
                salasContainer.innerHTML = "";
                paginationControls.classList.add("d-none");
                errorMessage.classList.add("d-none");
                noResults.classList.add("d-none");
                const capacidad = document.getElementById("capacidadMinima").value;
                const tipoEquipo = document.getElementById("tipoEquipo").value;
                const activa = document.getElementById("estado").value;
                const params = new URLSearchParams({
                page: page,
                        size: pageSize,
                        sort: 'nombre,asc'
                });
                if (capacidad) params.append('capacidadMinima', capacidad);
                if (tipoEquipo)
                params.append('tipoEquipo', tipoEquipo);
                if (activa !== "")
                params.append('activa', activa);
                const url = `/api/salas?${params.toString()}`;
                try {
                const response = await fetch(url, {
                method: "GET",
                        headers: {
                        "Authorization": `Bearer ${token}`,
                                "Content-Type" :  "a p plication/json"
                        }
                });
                        if (response.status === 401 || response.status === 403) {
                localStorage.removeItem("jwtToken");
                        window.location.href = "/login?error=auth";
                        return;
                }

                if (!response.ok) {
                throw new Error(`Error HTTP: ${response.status}`);
                }

                const data = await response.json();
                        renderSalas(data.content);
                        renderPagination(data);
                        if (data.content.length === 0) {
                noResults.classList.remove("d-none");
                }

                } catch (error) {
        console.error("Error al obtener salas:", error);
                errorMessage.classList.remove("d-none");
                errorMessage.textContent = "Error al cargar las salas. Por favor, intente de nuevo.";
        } finally {
        loadingSpinner.classList.add("d-none");
        }
        }

        function renderSalas(salas) {
        salasContainer.innerHTML = "";
                salas.forEach(sala => {

                const tituloSala = `
                        <a href="/sala-detalle?id=${sala.id}" class="text-decoration-none text-dark stretched-link">
                        ${sala.nombre}
                        </a>
                        `;
                        const salaCard = `
                        <div class="col-md-6">
                        <div class="card h-100 shadow-sm border-0">
                <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                <h5 class="card-title mb-1">${tituloSala}</h5> <!-- Título reemplazado -->
                        <span class="badge ${sala.activa ? 'bg-success-subtle text-success-emphasis' : 'bg-danger-subtle text-danger-emphasis'}">
                ${sala.activa ? 'Activa' :
                'Inactiva'}
                                        </span>
                                    </div>
                                    <h6 class="card-subtitle mb-2 text-muted">
                                        <i class="bi bi-geo-alt-fill me-1"></i> ${sala.ubicacion || 'Sin ubicación'}
                                    </h6>
                                    
                                    <p class="card-text">
                                        <i class="bi bi-people-fill me-1"></i> Capacidad: <strong>${sala.capacidad} personas</strong>
                                    </p>
                                    
                                    <p class="mb-1"><strong>Equipamiento:</strong></p>
                                    ${renderEquipos(sala.equipos)}

                                </div>
                                <div class="card-footer bg-white border-0 text-end" style="z-index: 2; position: relative;"> <!-- Añadido z-index -->
                                    <button class="btn btn-primary btn-sm" 
                                            onclick="window.location.href='/buscar'" 
                                            ${!sala.activa ? 'disabled' : ''}>
                                        Reservar
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
        salasContainer.insertAdjacentHTML("beforeend", salaCard);
        });
        }

        function renderEquipos(equipos) {
            if (!equipos || equipos.length === 0) {
                return '<span class="text-muted small">No hay equipos asignados.</span>';
            }
            
            let equipoHtml = '<div class="d-flex flex-wrap gap-1 mt-1">';
            equipos.forEach(equipo => {
                equipoHtml += `<span class="badge bg-secondary-subtle text-secondary-emphasis rounded-pill">${equipo.nombre}</span>`;
            });
            equipoHtml += '</div>';
            return equipoHtml;
        }

        function renderPagination(pageData) {
        if (pageData.totalPages <= 0) {
        paginationControls.classList.add('d-none');
        return;
        }

        paginationControls.classList.remove('d-none');
        currentPage = pageData.number;
        totalPages = pageData.totalPages;
        pageInfo.textContent = `Página ${currentPage + 1} de ${totalPages}`;
        if (pageData.first) {
        prevPage.classList.add("disabled");
        } else {
        prevPage.classList.remove("disabled");
        }

        if (pageData.last) {
        nextPage.classList.add("disabled");
        } else {
        nextPage.classList.remove("disabled");
        }
        }


        filterForm.addEventListener("submit", function (event) {
        event.preventDefault();
        fetchSalas(0);
        });
        prevPage.addEventListener("click", function (event) {
        event.preventDefault();
        if (currentPage > 0) {
        fetchSalas(currentPage - 1);
        }
        });
        nextPage.addEventListener("click", function (event) {
        event.preventDefault();
        if (currentPage < totalPages - 1) {
        fetchSalas(currentPage + 1);
        }
        });
        fetchSalas(0);
        });
    </script>

</body>
</html>
