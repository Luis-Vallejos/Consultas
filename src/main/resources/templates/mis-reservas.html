<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

    <head th:replace="~{layout/layout :: head('Mis Reservas')}">
    </head>

    <body class="d-flex flex-column min-vh-100">

        <header th:replace="~{layout/layout :: header}"></header>

        <main class="container flex-grow-1 my-4">

            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="mb-0">Mis Reservas</h1>
                <a th:href="@{/buscar}" class="btn btn-primary">
                    <i class="bi bi-plus-lg me-1"></i> Nueva Reserva
                </a>
            </div>

            <div id="loading-spinner" class="text-center my-5">
                <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-2">Cargando tus reservas...</p>
            </div>

            <div id="reservas-container" class="row g-4">
            </div>

            <div id="no-results" class="text-center my-5 d-none">
                <i class="bi bi-calendar-x fs-1 text-muted"></i>
                <h4 class="mt-3">No tienes reservas</h4>
                <p class="text-muted">Parece que aún no has hecho ninguna reserva. ¡Anímate a buscar una sala!</p>
            </div>
        </main>

        <div class="modal fade" id="confirmCancelModal" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalLabel">Confirmar Cancelación</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <p>¿Estás seguro de que deseas cancelar tu reserva para la sala <strong id="modal-sala-nombre"></strong>?</p>
                        <p class="text-muted small">Esta acción no se puede deshacer.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No, mantener</button>
                        <button type="button" class="btn btn-danger" id="modal-confirm-cancel-button">
                            Sí, cancelar
                        </button>
                    </div>
                </div>
            </div>
        </div>


        <footer th:replace="~{layout/layout :: footer}"></footer>

    <th:block th:replace="~{layout/layout :: scripts}"></th:block>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const token = localStorage.getItem("jwtToken");

            if (!token) {
                window.location.href = "/login?redirect=mis-reservas";
                return;
            }

            const loadingSpinner = document.getElementById("loading-spinner");
            const reservasContainer = document.getElementById("reservas-container");
            const noResults = document.getElementById("no-results");

            const confirmModal = new bootstrap.Modal(document.getElementById('confirmCancelModal'));
            const modalSalaNombre = document.getElementById("modal-sala-nombre");
            const modalConfirmCancelButton = document.getElementById("modal-confirm-cancel-button");

            let reservaParaCancelarId = null;

            async function loadReservas() {
                showLoading(true);
                try {
                    const response = await fetch("/api/reservas", {
                        headers: {"Authorization": `Bearer ${token}`}
                    });

                    if (!response.ok) {
                        throw new Error("No se pudieron cargar tus reservas.");
                    }

                    const reservas = await response.json();
                    renderReservas(reservas);

                } catch (error) {
                    console.error("Error cargando reservas:", error);
                    showGlobalToast("Error al cargar tus reservas. Intenta recargar la página.", "danger");
                } finally {
                    showLoading(false);
                }
            }

            function renderReservas(reservas) {
                reservasContainer.innerHTML = "";

                reservas.sort((a, b) => {
                    let aEsFuturaConfirmada = a.estado === 'CONFIRMADA' && new Date(a.inicio) > new Date();
                    let bEsFuturaConfirmada = b.estado === 'CONFIRMADA' && new Date(b.inicio) > new Date();

                    if (aEsFuturaConfirmada && !bEsFuturaConfirmada)
                        return -1;
                    if (!aEsFuturaConfirmada && bEsFuturaConfirmada)
                        return 1;

                    return new Date(a.inicio) - new Date(b.inicio);
                });


                if (reservas.length === 0) {
                    noResults.classList.remove("d-none");
                    return;
                }

                noResults.classList.add("d-none");

                reservas.forEach(reserva => {
                    const reservaCard = document.createElement("div");
                    reservaCard.className = "col-md-6";

                    const esCancelada = reserva.estado === 'CANCELADA';
                    const esPasada = new Date(reserva.fin) < new Date();
                    const puedeCancelar = !esCancelada && !esPasada;

                    let cardClass = 'shadow-sm border-0';
                    let statusBadge = `<span class="badge bg-success-subtle text-success-emphasis">Confirmada</span>`;

                    if (esCancelada) {
                        cardClass = 'border-0 bg-light';
                        statusBadge = `<span class="badge bg-danger-subtle text-danger-emphasis">Cancelada</span>`;
                    } else if (esPasada) {
                        cardClass = 'border-0 bg-light';
                        statusBadge = `<span class="badge bg-secondary-subtle text-secondary-emphasis">Finalizada</span>`;
                    }


                    reservaCard.innerHTML = `
                        <div class="card h-100 ${cardClass}">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <h5 class="card-title mb-1">${reserva.nombreSala}</h5>
                                    ${statusBadge}
                                </div>
                                <h6 class="card-subtitle mb-3 text-muted">
                                    <i class="bi bi-calendar-check me-1"></i>
                                    ${formatearFecha(reserva.inicio)}
                                </h6>
                                <p class="card-text mb-1">
                                    <strong>Inicio:</strong> ${formatearHora(reserva.inicio)}
                                </p>
                                <p class="card-text mb-1">
                                    <strong>Fin:</strong> ${formatearHora(reserva.fin)}
                                </p>
                                <p class="card-text small text-muted">
                                    ID Reserva: ${reserva.id}
                                </p>
                            </div>
                            ${puedeCancelar ? `
                            <div class="card-footer bg-white border-0 text-end">
                                <button class="btn btn-outline-danger btn-sm btn-cancelar" 
                                        data-reserva-id="${reserva.id}" 
                                        data-sala-nombre="${reserva.nombreSala}">
                                    <i class="bi bi-trash me-1"></i> Cancelar Reserva
                                </button>
                            </div>
                            ` : ''}
                        </div>
                    `;
                    reservasContainer.appendChild(reservaCard);
                });

                document.querySelectorAll('.btn-cancelar').forEach(button => {
                    button.addEventListener('click', () => {
                        reservaParaCancelarId = button.dataset.reservaId;
                        modalSalaNombre.textContent = button.dataset.salaNombre;
                        confirmModal.show();
                    });
                });
            }

            async function handleCancelReservation() {
                if (!reservaParaCancelarId)
                    return;

                modalConfirmCancelButton.disabled = true;

                try {
                    const response = await fetch(`/api/reservas/${reservaParaCancelarId}/cancelar`, {
                        method: "PUT",
                        headers: {"Authorization": `Bearer ${token}`}
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || "No se pudo cancelar la reserva.");
                    }

                    confirmModal.hide();
                    showGlobalToast(`Reserva (ID: ${reservaParaCancelarId}) cancelada exitosamente.`, 'success');
                    loadReservas(); // Recargar la lista

                } catch (error) {
                    console.error("Error al cancelar:", error);
                    confirmModal.hide(); // Ocultar el modal para mostrar el toast
                    showGlobalToast(error.message, 'danger');
                } finally {
                    modalConfirmCancelButton.disabled = false;
                    reservaParaCancelarId = null;
                }
            }

            function formatearFecha(fechaISO) {
                const fecha = new Date(fechaISO);
                return fecha.toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }

            function formatearHora(fechaISO) {
                const fecha = new Date(fechaISO);
                return fecha.toLocaleTimeString('es-ES', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                });
            }

            function showLoading(isLoading) {
                if (isLoading) {
                    loadingSpinner.classList.remove("d-none");
                    reservasContainer.classList.add("d-none");
                    noResults.classList.add("d-none");
                } else {
                    loadingSpinner.classList.add("d-none");
                    reservasContainer.classList.remove("d-none");
                }
            }

            modalConfirmCancelButton.addEventListener("click", handleCancelReservation);

            loadReservas();
        });
    </script>

</body>
</html>
